#!/usr/bin/env node
const envConfigs = require('dotenv');

const app = require('../app');
const pkg = require('../package.json');


envConfigs.config({ path: `${__dirname}/../.env` });

const PORT = process.env.PORT || 3000;


// Error handling middleware
app.use(async (ctx, next) => {
  try {
    await next();
    if (ctx.state.api === true && ctx.status === 200) {
      // ctx.status = 200;
      ctx.body = {
        error: false,
        result: ctx.body,
      };
    }
  } catch (err) {
    ctx.app.emit('error', err, this);
    ctx.status = err.status || 500;
    if (ctx.state.api === true) {
      return ctx.body = {
        error: true,
        message: err.message,
      };
    }
    await ctx.render('error', {
      message: err.message,
      error: {},
    });
  }
});


app.listen(PORT);
console.log(`${pkg.name} v${pkg.version} listening on port ${PORT}`);
